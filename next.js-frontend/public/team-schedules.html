<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Team Schedules | Visitor Management System</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Flatpickr Date Picker CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .main-content {
      margin-top: 2rem;
    }
    /* Responsive adjustments for all devices */
    @media (max-width: 768px) {
      .main-content {
        margin-top: 1rem;
        padding-left: 10px;
        padding-right: 10px;
      }
      h1 {
        font-size: 1.8rem;
      }
      .btn-sm {
        padding: 0.2rem 0.4rem;
        font-size: 0.75rem;
      }
      .view-toggle .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
      }
      /* Calendar mobile adjustments */
      .fc-toolbar-title {
        font-size: 1.1rem !important;
      }
      .fc-button {
        padding: 0.25rem 0.5rem !important;
        font-size: 0.8rem !important;
      }
      /* Make the calendar day cells more compact on mobile */
      .fc-daygrid-day-frame {
        padding: 2px !important;
      }
      .fc-event-title {
        font-size: 0.7rem !important;
      }
    }
    .card {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }
    .schedule-card {
      cursor: pointer;
    }
    .schedule-detail {
      display: none;
    }
    .badge-primary {
      background-color: #007bff;
      color: white;
    }
    .badge-success {
      background-color: #28a745;
      color: white;
    }
    .badge-info {
      background-color: #17a2b8;
      color: white;
    }
    .badge-warning {
      background-color: #ffc107;
      color: #212529;
    }
    .badge-secondary {
      background-color: #6c757d;
      color: white;
    }
    .member-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }
    .member-list-item {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid #e0e0e0;
    }
    .member-list-item:last-child {
      border-bottom: none;
    }
    .member-checkbox {
      margin-right: 10px;
    }
    .date-range-display {
      font-weight: bold;
      color: #495057;
    }
    .recurrence-badge {
      font-size: 0.8rem;
      padding: 0.3rem 0.5rem;
    }
    .schedule-actions {
      display: flex;
      gap: 5px;
    }
    .team-name {
      font-weight: 500;
      color: #6c757d;
    }
    .schedule-list {
      max-height: 600px;
      overflow-y: auto;
    }
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #6c757d;
    }
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      color: #dee2e6;
    }
    /* Custom switch for recurrence toggle */
    .form-switch .form-check-input {
      width: 3em;
    }
    .form-switch .form-check-input:checked {
      background-color: #28a745;
      border-color: #28a745;
    }
    /* Custom styling for recurrence options */
    .recurrence-options {
      background-color: #f8f9fa;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-top: 1rem;
    }
    .selected-members-container {
      background-color: #f8f9fa;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-top: 1rem;
      max-height: 200px;
      overflow-y: auto;
    }
    .selected-member-item {
      display: flex;
      align-items: center;
      background-color: #e9ecef;
      border-radius: 30px;
      padding: 0.3rem 0.8rem;
      margin: 0.3rem;
      display: inline-flex;
    }
    .selected-member-item img {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }
    .selected-member-item button {
      background: none;
      border: none;
      color: #dc3545;
      margin-left: 0.5rem;
      padding: 0;
      font-size: 0.8rem;
    }
    
    .cursor-pointer {
      cursor: pointer;
    }
    
    /* Responsive improvements for mobile devices */
    @media (max-width: 576px) {
      /* Make checkboxes and buttons easier to tap on mobile */
      .form-check-input, .btn-sm {
        min-width: 1.2rem;
        min-height: 1.2rem;
      }
      
      /* Add more padding to clickable elements for easier touch */
      .member-list-item, .selected-member-item {
        padding: 0.5rem 0.3rem;
      }
      
      /* Improve member display on very small screens */
      .member-avatar {
        margin-right: 5px;
      }
      
      /* Make sure text doesn't overflow on small screens */
      .text-truncate {
        max-width: 120px;
      }
      
      /* Make sure modal fits well on small screens */
      .modal-dialog {
        margin: 0.5rem;
      }
      
      /* Adjust calendar columns on small screens */
      .fc-col-header-cell-cushion, .fc-daygrid-day-number {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">Visitor Management System</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/dashboard">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/members.html">Members</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/teams.html">Teams</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/team-schedules.html">Team Schedules</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/settings.html">Settings</a>
          </li>
        </ul>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="#" id="logoutBtn">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container main-content">
    <div class="row mb-4">
      <div class="col-md-8">
        <h1>Team Schedules</h1>
        <p class="text-muted">Create and manage schedules for your team members</p>
      </div>
      <div class="col-md-4 text-end">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createScheduleModal">
          <i class="fas fa-calendar-plus"></i> Create Schedule
        </button>
      </div>
    </div>

    <!-- Team Filter Dropdown -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="input-group">
          <label class="input-group-text" for="teamFilter">Filter by Team:</label>
          <select class="form-select" id="teamFilter">
            <option value="all" selected>All Teams</option>
            <!-- Teams will be populated here -->
          </select>
        </div>
      </div>
      <div class="col-md-6">
        <div class="input-group">
          <input type="text" class="form-control" id="scheduleSearch" placeholder="Search schedules...">
          <button class="btn btn-outline-secondary" type="button">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Schedules Grid/List View -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Team Schedules</h5>
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-outline-primary btn-sm active" id="listViewBtn">
                <i class="fas fa-list"></i> List
              </button>
              <button type="button" class="btn btn-outline-primary btn-sm" id="calendarViewBtn">
                <i class="fas fa-calendar-alt"></i> Calendar
              </button>
            </div>
          </div>
          <div class="card-body">
            <!-- List View (default) -->
            <div id="listView">
              <div id="schedulesList" class="schedule-list">
                <!-- Schedules will be populated here -->
                <div class="empty-state" id="emptyState">
                  <i class="fas fa-calendar-alt"></i>
                  <h4>No Schedules Found</h4>
                  <p>Create your first team schedule to get started</p>
                  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createScheduleModal">
                    Create Schedule
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Calendar View (initially hidden) -->
            <div id="calendarView" style="display: none;">
              <div class="row mb-3">
                <!-- Filter sidebar, stacked on mobile and side-by-side on desktop -->
                <div class="col-lg-3 col-md-4 mb-3 mb-md-0">
                  <!-- Mobile collapsible filter panel -->
                  <div class="d-md-none mb-3">
                    <button class="btn btn-outline-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
                      <i class="fas fa-filter me-2"></i>Show/Hide Filters
                    </button>
                  </div>
                  
                  <div class="collapse d-md-block" id="filterCollapse">
                    <div class="card">
                      <div class="card-header">
                        <h5 class="mb-0">Filters</h5>
                      </div>
                      <div class="card-body">
                        <!-- Search -->
                        <div class="mb-3">
                          <label for="calendarSearch" class="form-label">Search</label>
                          <div class="input-group">
                            <input type="text" class="form-control" id="calendarSearch" placeholder="Search teams or members...">
                            <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn">
                              <i class="fas fa-times"></i>
                            </button>
                          </div>
                        </div>
                        
                        <!-- Team Selection -->
                        <div class="mb-3">
                          <label class="form-label">Teams</label>
                          <div class="team-filter-list" id="teamFilterList">
                            <!-- Team checkboxes will be populated here -->
                            <div class="d-flex justify-content-between mb-2">
                              <button class="btn btn-sm btn-outline-primary" id="selectAllTeamsBtn">Select All</button>
                              <button class="btn btn-sm btn-outline-secondary" id="clearAllTeamsBtn">Clear All</button>
                            </div>
                            <div id="teamCheckboxes">
                              <!-- Dynamically populated -->
                            </div>
                          </div>
                        </div>
                        
                        <!-- Date Range Navigation -->
                        <div class="mb-3">
                          <label class="form-label">Date Range</label>
                          <div class="btn-group w-100 mb-2">
                            <button type="button" class="btn btn-outline-primary" id="prevBtn">
                              <i class="fas fa-chevron-left"></i>
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="todayBtn">Today</button>
                            <button type="button" class="btn btn-outline-primary" id="nextBtn">
                              <i class="fas fa-chevron-right"></i>
                            </button>
                          </div>
                          
                          <div class="btn-group w-100">
                            <button type="button" class="btn btn-outline-secondary view-option active" data-view="dayGridMonth">Month</button>
                            <button type="button" class="btn btn-outline-secondary view-option" data-view="timeGridWeek">Week</button>
                            <button type="button" class="btn btn-outline-secondary view-option" data-view="timeGridDay">Day</button>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Legend -->
                    <div class="card mt-3">
                      <div class="card-header">
                        <h5 class="mb-0">Legend</h5>
                      </div>
                      <div class="card-body p-0">
                        <ul class="list-group list-group-flush" id="calendarLegend">
                          <!-- Will be populated with team colors -->
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Calendar panel, takes full width on mobile -->
                <div class="col-lg-9 col-md-8">
                  <div class="card">
                    <div class="card-body">
                      <div id="calendar"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Schedule Modal -->
  <div class="modal fade" id="createScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create Team Schedule</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="createScheduleForm">
            <!-- Title and Team selection, stacked on mobile -->
            <div class="row mb-3">
              <div class="col-md-7 mb-3 mb-md-0">
                <label for="scheduleTitle" class="form-label">Schedule Title</label>
                <input type="text" class="form-control" id="scheduleTitle" placeholder="e.g., Weekly Team Meeting" required>
              </div>
              <div class="col-md-5">
                <label for="teamSelect" class="form-label">Team</label>
                <select class="form-select" id="teamSelect" required>
                  <option value="" selected disabled>Select a team</option>
                  <!-- Teams will be populated here -->
                </select>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="scheduleDescription" class="form-label">Description (Optional)</label>
              <textarea class="form-control" id="scheduleDescription" rows="2"></textarea>
            </div>
            
            <!-- Date selection, stacked on mobile -->
            <div class="row mb-3">
              <div class="col-md-6 mb-3 mb-md-0">
                <label for="scheduleStartDate" class="form-label">Start Date</label>
                <input type="text" class="form-control date-picker" id="scheduleStartDate" required>
              </div>
              <div class="col-md-6">
                <label for="scheduleEndDate" class="form-label">End Date</label>
                <input type="text" class="form-control date-picker" id="scheduleEndDate" required>
              </div>
            </div>
            
            <div class="mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="isRecurring">
                <label class="form-check-label" for="isRecurring">Recurring Schedule</label>
              </div>
            </div>
            
            <div class="recurrence-options" id="recurrenceOptions" style="display: none;">
              <div class="row mb-3">
                <div class="col-md-6 mb-3 mb-md-0">
                  <label for="recurrenceType" class="form-label">Recurrence Pattern</label>
                  <select class="form-select" id="recurrenceType">
                    <option value="none">No Recurrence</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="biweekly">Bi-weekly</option>
                    <option value="monthly">Monthly</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="recurrenceEndDate" class="form-label">Recurrence End Date</label>
                  <input type="text" class="form-control date-picker" id="recurrenceEndDate">
                </div>
              </div>
              
              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                  <label class="form-label mb-2">Additional Dates</label>
                  <button type="button" class="btn btn-sm btn-outline-primary mb-2" id="addDateRangeBtn">
                    <i class="fas fa-plus"></i> Add Date Range
                  </button>
                </div>
                <div id="additionalDatesContainer"></div>
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Team Members</label>
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                  <span class="mb-2 mb-sm-0">Select Members</span>
                  <div>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllMembers">Select All</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAllMembers">Clear</button>
                  </div>
                </div>
                <div class="card-body">
                  <div id="teamMembersList" style="max-height: 200px; overflow-y: auto;">
                    <!-- Team members will be populated here -->
                    <div class="text-center p-3 text-muted">
                      <i class="fas fa-users"></i>
                      <p>Please select a team first</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div id="selectedMembersContainer" class="selected-members-container" style="display: none;">
              <label class="form-label">Selected Members</label>
              <div id="selectedMembersList" class="d-flex flex-wrap">
                <!-- Selected members will be displayed here -->
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer flex-wrap">
          <button type="button" class="btn btn-secondary me-2 mb-2" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary mb-2" id="createScheduleBtn">Create Schedule</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Schedule Detail Modal -->
  <div class="modal fade" id="scheduleDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="scheduleDetailTitle">Schedule Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="scheduleDetailContent">
          <!-- Schedule details will be populated here -->
        </div>
        <div class="modal-footer flex-wrap">
          <button type="button" class="btn btn-secondary me-2 mb-2" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary mb-2" id="editScheduleBtn">Edit Schedule</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Flatpickr Date Picker -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- FullCalendar Library -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
  <!-- Main JavaScript -->
  <script>
    // Global variables
    let teams = [];
    let schedules = [];
    let currentTeamId = 'all';
    let teamMembers = [];
    let selectedMembers = new Set();
    let calendar = null;
    let calendarInitialized = false;
    let selectedTeams = new Set(); // For calendar view filtering
    let teamColors = {}; // For team color coding
    
    // DOM elements
    const teamFilter = document.getElementById('teamFilter');
    const teamSelect = document.getElementById('teamSelect');
    const schedulesList = document.getElementById('schedulesList');
    const emptyState = document.getElementById('emptyState');
    const teamMembersList = document.getElementById('teamMembersList');
    const selectedMembersContainer = document.getElementById('selectedMembersContainer');
    const selectedMembersList = document.getElementById('selectedMembersList');
    const isRecurringCheckbox = document.getElementById('isRecurring');
    const recurrenceOptions = document.getElementById('recurrenceOptions');
    const scheduleDetailContent = document.getElementById('scheduleDetailContent');
    const scheduleDetailTitle = document.getElementById('scheduleDetailTitle');
    const createScheduleBtn = document.getElementById('createScheduleBtn');
    const selectAllMembersBtn = document.getElementById('selectAllMembers');
    const clearAllMembersBtn = document.getElementById('clearAllMembers');
    
    // View toggle buttons
    const listViewBtn = document.getElementById('listViewBtn');
    const calendarViewBtn = document.getElementById('calendarViewBtn');
    const listView = document.getElementById('listView');
    const calendarView = document.getElementById('calendarView');
    
    // Initialize date pickers
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize date pickers
      initializeDatePickers();
      
      // Fetch initial data
      fetchTeams();
      
      // Setup event listeners
      setupEventListeners();
      
      // Setup modal event handlers to fix modal closure issues
      setupModalEventHandlers();
    });
    
    // Setup modal event handlers
    function setupModalEventHandlers() {
      try {
        // Safely add event listeners with error handling
        const createScheduleModal = document.getElementById('createScheduleModal');
        if (createScheduleModal) {
          createScheduleModal.addEventListener('hidden.bs.modal', function(event) {
            try {
              // Remove any lingering backdrops
              const backdrop = document.querySelector('.modal-backdrop');
              if (backdrop) backdrop.remove();
              
              // Reset body classes and styles
              document.body.classList.remove('modal-open');
              document.body.style.overflow = '';
              document.body.style.paddingRight = '';
            } catch (error) {
              console.error('Error handling create schedule modal hidden event:', error);
            }
          });
        }
        
        const scheduleDetailModal = document.getElementById('scheduleDetailModal');
        if (scheduleDetailModal) {
          scheduleDetailModal.addEventListener('hidden.bs.modal', function(event) {
            try {
              // Remove any lingering backdrops
              const backdrop = document.querySelector('.modal-backdrop');
              if (backdrop) backdrop.remove();
              
              // Reset body classes and styles
              document.body.classList.remove('modal-open');
              document.body.style.overflow = '';
              document.body.style.paddingRight = '';
            } catch (error) {
              console.error('Error handling schedule detail modal hidden event:', error);
            }
          });
        }
        
        // Add error handling for Bootstrap modals
        const fixBootstrapModalBackdropIssue = () => {
          if (document.querySelectorAll('.modal.show').length === 0 && document.querySelector('.modal-backdrop')) {
            // No visible modals but backdrop exists - remove it
            document.querySelector('.modal-backdrop').remove();
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
          }
        };
        
        // Check periodically for stuck backdrop issues
        setInterval(fixBootstrapModalBackdropIssue, 2000);
      } catch (error) {
        console.error('Error setting up modal event handlers:', error);
      }
    }
    
    function initializeDatePickers() {
      const dateOptions = {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "F j, Y",
        minDate: "today",
      };
      
      flatpickr("#scheduleStartDate", {
        ...dateOptions,
        onChange: function(selectedDates, dateStr) {
          const endDatePicker = document.getElementById("scheduleEndDate")._flatpickr;
          endDatePicker.set("minDate", dateStr);
        }
      });
      
      flatpickr("#scheduleEndDate", dateOptions);
      flatpickr("#recurrenceEndDate", dateOptions);
      
      // Initialize any existing additional date pickers
      document.querySelectorAll('.additional-date-start').forEach(el => {
        initializeAdditionalDatePicker(el);
      });
      
      document.querySelectorAll('.additional-date-end').forEach(el => {
        initializeAdditionalDatePicker(el, true);
      });
    }
    
    // Initialize date picker for additional date fields
    function initializeAdditionalDatePicker(element, isEndDate = false) {
      const dateOptions = {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "F j, Y",
        minDate: "today",
      };
      
      if (!isEndDate) {
        flatpickr(element, {
          ...dateOptions,
          onChange: function(selectedDates, dateStr) {
            // Find the corresponding end date picker
            const endDateId = element.id.replace('Start', 'End');
            const endDatePicker = document.getElementById(endDateId)._flatpickr;
            endDatePicker.set("minDate", dateStr);
          }
        });
      } else {
        flatpickr(element, dateOptions);
      }
    }
    
    function setupEventListeners() {
      // Team filter change
      teamFilter.addEventListener('change', function() {
        currentTeamId = this.value;
        fetchSchedules(currentTeamId);
      });
      
      // Team select change
      teamSelect.addEventListener('change', function() {
        const teamId = this.value;
        if (teamId) {
          fetchTeamMembers(teamId);
        } else {
          teamMembersList.innerHTML = '<div class="text-center p-3 text-muted"><i class="fas fa-users"></i><p>Please select a team first</p></div>';
        }
      });
      
      // View toggle buttons
      listViewBtn.addEventListener('click', function() {
        listViewBtn.classList.add('active');
        calendarViewBtn.classList.remove('active');
        listView.style.display = 'block';
        calendarView.style.display = 'none';
      });
      
      calendarViewBtn.addEventListener('click', function() {
        calendarViewBtn.classList.add('active');
        listViewBtn.classList.remove('active');
        calendarView.style.display = 'block';
        listView.style.display = 'none';
        
        // Initialize the calendar if it's not already initialized
        if (!calendarInitialized) {
          initializeCalendar();
          populateTeamCheckboxes();
          setupCalendarControls();
        }
      });
      
      // Recurrence toggle
      isRecurringCheckbox.addEventListener('change', function() {
        if (this.checked) {
          recurrenceOptions.style.display = 'block';
        } else {
          recurrenceOptions.style.display = 'none';
          // Clear any additional date ranges when disabling recurrence
          document.getElementById('additionalDatesContainer').innerHTML = '';
        }
      });
      
      // Add date range button
      document.getElementById('addDateRangeBtn').addEventListener('click', addDateRange);
      
      // Select/Clear all members
      selectAllMembersBtn.addEventListener('click', selectAllMembers);
      clearAllMembersBtn.addEventListener('click', clearAllMembers);
      
      // Create schedule button
      createScheduleBtn.addEventListener('click', createSchedule);
    }
    
    // Add a new date range row
    function addDateRange() {
      const container = document.getElementById('additionalDatesContainer');
      const dateRangeId = Date.now(); // Use timestamp to create unique IDs
      
      const dateRangeHtml = `
        <div class="additional-date-range card mb-2" data-id="${dateRangeId}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
              <h6 class="mb-0 me-2">Additional Date Range</h6>
              <button type="button" class="btn btn-sm btn-outline-danger remove-date-range" data-id="${dateRangeId}">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3 mb-md-0">
                <label class="form-label">Start Date</label>
                <input type="text" class="form-control date-picker additional-date-start" id="additionalDateStart-${dateRangeId}">
              </div>
              <div class="col-md-6">
                <label class="form-label">End Date</label>
                <input type="text" class="form-control date-picker additional-date-end" id="additionalDateEnd-${dateRangeId}">
              </div>
            </div>
          </div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', dateRangeHtml);
      
      // Initialize the new date pickers
      const startDateInput = document.getElementById(`additionalDateStart-${dateRangeId}`);
      const endDateInput = document.getElementById(`additionalDateEnd-${dateRangeId}`);
      
      initializeAdditionalDatePicker(startDateInput);
      initializeAdditionalDatePicker(endDateInput, true);
      
      // Add event listener to remove button
      document.querySelector(`.remove-date-range[data-id="${dateRangeId}"]`).addEventListener('click', function() {
        removeAdditionalDateRange(dateRangeId);
      });
    }
    
    // Remove an additional date range
    function removeAdditionalDateRange(dateRangeId) {
      const dateRange = document.querySelector(`.additional-date-range[data-id="${dateRangeId}"]`);
      if (dateRange) {
        dateRange.remove();
      }
    }
    
    // Collect all date ranges from the form
    function collectAdditionalDateRanges() {
      const additionalDates = [];
      
      document.querySelectorAll('.additional-date-range').forEach(range => {
        const dateRangeId = range.getAttribute('data-id');
        const startDate = document.getElementById(`additionalDateStart-${dateRangeId}`).value;
        const endDate = document.getElementById(`additionalDateEnd-${dateRangeId}`).value;
        
        if (startDate && endDate) {
          additionalDates.push({
            startDate,
            endDate
          });
        }
      });
      
      return additionalDates;
    }
    
    // Fetch all teams
    async function fetchTeams() {
      try {
        const response = await fetch('/api/teams');
        if (!response.ok) {
          throw new Error('Failed to fetch teams');
        }
        
        teams = await response.json();
        
        // Populate team filter dropdown
        populateTeamDropdowns();
        
        // Fetch schedules for all teams initially
        fetchSchedules('all');
      } catch (error) {
        console.error('Error fetching teams:', error);
        showErrorAlert('Failed to load teams. Please try again later.');
      }
    }
    
    // Populate team dropdowns (filter and select)
    function populateTeamDropdowns() {
      // Clear existing options except the first one
      teamFilter.innerHTML = '<option value="all" selected>All Teams</option>';
      teamSelect.innerHTML = '<option value="" selected disabled>Select a team</option>';
      
      // Add team options
      teams.forEach(team => {
        // For filter dropdown
        const filterOption = document.createElement('option');
        filterOption.value = team.id;
        filterOption.textContent = team.name;
        teamFilter.appendChild(filterOption);
        
        // For select dropdown in create form
        const selectOption = document.createElement('option');
        selectOption.value = team.id;
        selectOption.textContent = team.name;
        teamSelect.appendChild(selectOption);
      });
    }
    
    // Fetch schedules for a specific team or all teams
    async function fetchSchedules(teamId) {
      try {
        schedules = [];
        
        // For "all" we need to fetch schedules for each team and combine them
        if (teamId === 'all') {
          for (const team of teams) {
            const response = await fetch(`/api/teams/${team.id}/schedules`);
            if (response.ok) {
              const teamSchedules = await response.json();
              schedules = [...schedules, ...teamSchedules];
            }
          }
        } else {
          const response = await fetch(`/api/teams/${teamId}/schedules`);
          if (!response.ok) {
            throw new Error('Failed to fetch schedules');
          }
          schedules = await response.json();
        }
        
        // Display schedules
        renderSchedules(schedules);
        
        // Update calendar if it's initialized
        if (calendarInitialized) {
          updateCalendarEvents();
        }
      } catch (error) {
        console.error('Error fetching schedules:', error);
        showErrorAlert('Failed to load schedules. Please try again later.');
      }
    }
    
    // Render schedules in the list view
    function renderSchedules(schedules) {
      if (schedules.length === 0) {
        emptyState.style.display = 'block';
        schedulesList.innerHTML = '';
      } else {
        emptyState.style.display = 'none';
        
        // Sort schedules by start date (most recent first)
        schedules.sort((a, b) => new Date(b.start_date) - new Date(a.start_date));
        
        let html = '';
        schedules.forEach(schedule => {
          const startDate = new Date(schedule.start_date).toLocaleDateString();
          const endDate = new Date(schedule.end_date).toLocaleDateString();
          
          // Generate recurrence badge
          let recurrenceBadge = '';
          if (schedule.recurrence_type && schedule.recurrence_type !== 'none') {
            const badgeClass = getRecurrenceBadgeClass(schedule.recurrence_type);
            recurrenceBadge = `<span class="badge ${badgeClass} recurrence-badge">
              <i class="fas fa-repeat me-1"></i>${capitalize(schedule.recurrence_type)}
            </span>`;
          }
          
          html += `
            <div class="card schedule-card mb-3" data-id="${schedule.id}">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start flex-wrap">
                  <div class="mb-2 mb-sm-0 me-2">
                    <h5 class="card-title">${schedule.title}</h5>
                    <p class="card-text text-muted team-name">
                      <i class="fas fa-users me-1"></i>${schedule.team_name}
                    </p>
                  </div>
                  <div class="schedule-actions">
                    <button class="btn btn-outline-primary btn-sm view-schedule" data-id="${schedule.id}">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm delete-schedule" data-id="${schedule.id}">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
                <div class="date-range-display mt-2">
                  <i class="fas fa-calendar-alt me-2"></i>
                  ${startDate} to ${endDate}
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2 flex-wrap">
                  <div class="mb-2 mb-sm-0">${recurrenceBadge}</div>
                  <span class="badge bg-secondary">
                    <i class="fas fa-user me-1"></i>${schedule.member_count || 0} Members
                  </span>
                </div>
              </div>
            </div>
          `;
        });
        
        schedulesList.innerHTML = html;
        
        // Add event listeners to view and delete buttons
        document.querySelectorAll('.view-schedule').forEach(button => {
          button.addEventListener('click', function() {
            const scheduleId = this.getAttribute('data-id');
            viewScheduleDetails(scheduleId);
          });
        });
        
        document.querySelectorAll('.delete-schedule').forEach(button => {
          button.addEventListener('click', function(e) {
            e.stopPropagation();
            if (confirm('Are you sure you want to delete this schedule?')) {
              const scheduleId = this.getAttribute('data-id');
              deleteSchedule(scheduleId);
            }
          });
        });
        
        // Make entire card clickable
        document.querySelectorAll('.schedule-card').forEach(card => {
          card.addEventListener('click', function() {
            const scheduleId = this.getAttribute('data-id');
            viewScheduleDetails(scheduleId);
          });
        });
      }
    }
    
    // Fetch members of a specific team
    async function fetchTeamMembers(teamId) {
      try {
        const response = await fetch(`/api/teams/${teamId}`);
        if (!response.ok) {
          throw new Error('Failed to fetch team details');
        }
        
        const team = await response.json();
        teamMembers = team.members || [];
        
        // Clear selected members
        selectedMembers.clear();
        updateSelectedMembersDisplay();
        
        // Render team members list
        renderTeamMembers();
      } catch (error) {
        console.error('Error fetching team members:', error);
        showErrorAlert('Failed to load team members. Please try again later.');
      }
    }
    
    // Render team members list with checkboxes
    function renderTeamMembers() {
      if (teamMembers.length === 0) {
        teamMembersList.innerHTML = '<div class="text-center p-3 text-muted"><i class="fas fa-users"></i><p>No members in this team</p></div>';
        return;
      }
      
      let html = '';
      teamMembers.forEach(member => {
        // Handle both camelCase and snake_case properties
        const firstName = member.firstName || member.first_name;
        const lastName = member.lastName || member.last_name;
        const pictureUrl = member.pictureUrl || member.picture_url;
        
        const memberName = `${firstName} ${lastName}`;
        const avatarUrl = pictureUrl || 'https://via.placeholder.com/40';
        
        html += `
          <div class="member-list-item" data-id="${member.id}">
            <input type="checkbox" class="member-checkbox form-check-input" id="member-${member.id}" value="${member.id}">
            <label for="member-${member.id}" class="d-flex align-items-center w-100 cursor-pointer">
              <img src="${avatarUrl}" alt="${memberName}" class="member-avatar">
              <span class="text-truncate">${memberName}</span>
            </label>
          </div>
        `;
      });
      
      teamMembersList.innerHTML = html;
      
      // Add event listeners to checkboxes
      document.querySelectorAll('.member-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const memberId = parseInt(this.value);
          
          if (this.checked) {
            selectedMembers.add(memberId);
          } else {
            selectedMembers.delete(memberId);
          }
          
          updateSelectedMembersDisplay();
        });
      });
      
      // Make entire row clickable
      document.querySelectorAll('.member-list-item').forEach(item => {
        item.addEventListener('click', function(e) {
          // Don't handle clicks on the checkbox itself (it handles its own events)
          if (e.target.type !== 'checkbox') {
            const checkbox = this.querySelector('.member-checkbox');
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change'));
          }
        });
      });
    }
    
    // Select all members
    function selectAllMembers() {
      teamMembers.forEach(member => {
        selectedMembers.add(member.id);
        const checkbox = document.getElementById(`member-${member.id}`);
        if (checkbox) checkbox.checked = true;
      });
      
      updateSelectedMembersDisplay();
    }
    
    // Clear all selected members
    function clearAllMembers() {
      selectedMembers.clear();
      document.querySelectorAll('.member-checkbox').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      updateSelectedMembersDisplay();
    }
    
    // Update the selected members display
    function updateSelectedMembersDisplay() {
      if (selectedMembers.size === 0) {
        selectedMembersContainer.style.display = 'none';
        return;
      }
      
      selectedMembersContainer.style.display = 'block';
      let html = '';
      
      selectedMembers.forEach(memberId => {
        const member = teamMembers.find(m => m.id === memberId);
        if (member) {
          // Handle both camelCase and snake_case properties
          const firstName = member.firstName || member.first_name;
          const lastName = member.lastName || member.last_name;
          const pictureUrl = member.pictureUrl || member.picture_url;
          
          const memberName = `${firstName} ${lastName}`;
          const avatarUrl = pictureUrl || 'https://via.placeholder.com/25';
          
          html += `
            <div class="selected-member-item">
              <img src="${avatarUrl}" alt="${memberName}">
              <span>${memberName}</span>
              <button type="button" class="remove-selected-member" data-id="${member.id}">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
        }
      });
      
      selectedMembersList.innerHTML = html;
      
      // Add event listeners to remove buttons
      document.querySelectorAll('.remove-selected-member').forEach(button => {
        button.addEventListener('click', function() {
          const memberId = parseInt(this.getAttribute('data-id'));
          selectedMembers.delete(memberId);
          
          // Uncheck the corresponding checkbox
          const checkbox = document.getElementById(`member-${memberId}`);
          if (checkbox) checkbox.checked = false;
          
          updateSelectedMembersDisplay();
        });
      });
    }
    
    // Store modal instance for creating schedules
    let createScheduleModalInstance = null;
    
    // Create a new schedule
    async function createSchedule() {
      try {
        // Get form values
        const title = document.getElementById('scheduleTitle').value;
        const teamId = document.getElementById('teamSelect').value;
        const description = document.getElementById('scheduleDescription').value;
        const startDate = document.getElementById('scheduleStartDate').value;
        const endDate = document.getElementById('scheduleEndDate').value;
        const isRecurring = document.getElementById('isRecurring').checked;
        const recurrenceType = isRecurring ? document.getElementById('recurrenceType').value : 'none';
        const recurrenceEndDate = isRecurring ? document.getElementById('recurrenceEndDate').value : null;
        
        // Validate inputs
        if (!title || !teamId || !startDate || !endDate) {
          showErrorAlert('Please fill in all required fields.');
          return;
        }
        
        if (selectedMembers.size === 0) {
          showErrorAlert('Please select at least one team member.');
          return;
        }
        
        // Collect additional date ranges if this is a recurring schedule
        const additionalDates = isRecurring ? collectAdditionalDateRanges() : [];
        
        // Prepare request data
        const scheduleData = {
          title,
          description,
          startDate,
          endDate,
          recurrenceType,
          recurrenceEndDate,
          additionalDates,
          memberIds: Array.from(selectedMembers)
        };
        
        // Send request to create schedule
        const response = await fetch(`/api/teams/${teamId}/schedules`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(scheduleData)
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to create schedule');
        }
        
        const newSchedule = await response.json();
        
        // Properly close the modal
        const modalElement = document.getElementById('createScheduleModal');
        const modal = bootstrap.Modal.getInstance(modalElement);
        
        if (modal) {
          modal.hide();
          
          // Ensure the backdrop is removed
          setTimeout(() => {
            if (document.querySelector('.modal-backdrop')) {
              document.querySelector('.modal-backdrop').remove();
              document.body.classList.remove('modal-open');
              document.body.style.overflow = '';
              document.body.style.paddingRight = '';
            }
          }, 200);
        }
        
        document.getElementById('createScheduleForm').reset();
        
        // Clear selected members
        selectedMembers.clear();
        updateSelectedMembersDisplay();
        
        // Hide recurrence options
        recurrenceOptions.style.display = 'none';
        
        // Refresh schedules
        fetchSchedules(currentTeamId);
        
        // Show success message
        showSuccessAlert('Schedule created successfully!');
      } catch (error) {
        console.error('Error creating schedule:', error);
        showErrorAlert(error.message || 'Failed to create schedule. Please try again.');
      }
    }
    
    // Store modal instance
    let scheduleDetailModalInstance = null;
    
    // View schedule details
    async function viewScheduleDetails(scheduleId) {
      try {
        const response = await fetch(`/api/team-schedules/${scheduleId}`);
        if (!response.ok) {
          throw new Error('Failed to fetch schedule details');
        }
        
        const schedule = await response.json();
        
        // Format dates
        const startDate = new Date(schedule.start_date).toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        const endDate = new Date(schedule.end_date).toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        // Recurrence info
        let recurrenceInfo = 'No recurrence';
        if (schedule.recurrence_type && schedule.recurrence_type !== 'none') {
          recurrenceInfo = `${capitalize(schedule.recurrence_type)}`;
          
          if (schedule.recurrence_end_date) {
            const recurrenceEndDate = new Date(schedule.recurrence_end_date).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
            recurrenceInfo += ` until ${recurrenceEndDate}`;
          }
        }
        
        // Additional dates
        let additionalDatesHtml = '';
        if (schedule.recurrence_dates && typeof schedule.recurrence_dates === 'object') {
          const additionalDates = Array.isArray(schedule.recurrence_dates) ? schedule.recurrence_dates : [schedule.recurrence_dates];
          
          if (additionalDates.length > 0) {
            additionalDatesHtml = '<div class="mt-3"><h6>Additional Date Ranges:</h6><ul class="list-group">';
            
            additionalDates.forEach(dateRange => {
              const rangeStartDate = new Date(dateRange.startDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              });
              
              const rangeEndDate = new Date(dateRange.endDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              });
              
              additionalDatesHtml += `
                <li class="list-group-item">
                  <i class="fas fa-calendar-alt me-2"></i>
                  ${rangeStartDate} to ${rangeEndDate}
                </li>
              `;
            });
            
            additionalDatesHtml += '</ul></div>';
          }
        }
        
        // Generate members HTML
        let membersHtml = '';
        if (schedule.members && schedule.members.length > 0) {
          schedule.members.forEach(member => {
            // Handle both camelCase and snake_case properties
            const firstName = member.firstName || member.first_name;
            const lastName = member.lastName || member.last_name;
            const pictureUrl = member.pictureUrl || member.picture_url;
            
            const memberName = `${firstName} ${lastName}`;
            const avatarUrl = pictureUrl || 'https://via.placeholder.com/40';
            
            membersHtml += `
              <div class="d-flex align-items-center mb-2">
                <img src="${avatarUrl}" alt="${memberName}" class="member-avatar">
                <span class="text-truncate">${memberName}</span>
              </div>
            `;
          });
        } else {
          membersHtml = '<p class="text-muted">No members in this schedule</p>';
        }
        
        // Recurrence badge
        let recurrenceBadge = '';
        if (schedule.recurrence_type && schedule.recurrence_type !== 'none') {
          const badgeClass = getRecurrenceBadgeClass(schedule.recurrence_type);
          recurrenceBadge = `<span class="badge ${badgeClass} me-2">
            <i class="fas fa-repeat me-1"></i>${capitalize(schedule.recurrence_type)}
          </span>`;
        }
        
        // Update modal content
        scheduleDetailTitle.innerHTML = schedule.title;
        scheduleDetailContent.innerHTML = `
          <div class="row">
            <div class="col-md-8 mb-4 mb-md-0">
              <h5 class="mb-3">Schedule Details</h5>
              <div class="card mb-3">
                <div class="card-body">
                  <p><strong>Team:</strong> ${schedule.team_name}</p>
                  <p><strong>Description:</strong> ${schedule.description || 'No description'}</p>
                  <p><strong>Date Range:</strong> ${startDate} to ${endDate}</p>
                  <p><strong>Recurrence:</strong> ${recurrenceInfo}</p>
                  <div class="mt-3 d-flex flex-wrap">
                    <div class="me-2 mb-2">${recurrenceBadge}</div>
                    <span class="badge bg-secondary mb-2">
                      <i class="fas fa-user me-1"></i>${schedule.members ? schedule.members.length : 0} Members
                    </span>
                  </div>
                  ${additionalDatesHtml}
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <h5 class="mb-3">Team Members</h5>
              <div class="card">
                <div class="card-body">
                  <div class="members-list" style="max-height: 250px; overflow-y: auto;">
                    ${membersHtml}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        try {
          // Check if we already have a modal instance
          if (scheduleDetailModalInstance) {
            try {
              // Properly dispose the old modal instance
              scheduleDetailModalInstance.dispose();
            } catch (modalError) {
              console.warn('Error disposing previous modal instance:', modalError);
            }
            scheduleDetailModalInstance = null;
          }
          
          // Get the modal element
          const modalElement = document.getElementById('scheduleDetailModal');
          
          // Create a new modal instance with error handling
          try {
            scheduleDetailModalInstance = new bootstrap.Modal(modalElement, {
              backdrop: true,
              keyboard: true,
              focus: true
            });
            
            // Add event listener for when modal is hidden
            modalElement.addEventListener('hidden.bs.modal', function () {
              try {
                // Cleanup to prevent memory leaks
                if (scheduleDetailModalInstance) {
                  scheduleDetailModalInstance.dispose();
                  scheduleDetailModalInstance = null;
                }
                
                // Also cleanup any lingering backdrop
                setTimeout(() => {
                  const backdrop = document.querySelector('.modal-backdrop');
                  if (backdrop) {
                    backdrop.remove();
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                  }
                }, 150);
              } catch (error) {
                console.error('Error in modal hidden event:', error);
              }
            }, { once: true }); // Use 'once' to ensure this only executes once
            
            // Show the modal with error handling
            scheduleDetailModalInstance.show();
          } catch (modalError) {
            console.error('Error creating or showing modal:', modalError);
            
            // Fallback approach if modal creation fails
            if (modalElement && typeof modalElement.classList !== 'undefined') {
              modalElement.classList.add('show');
              modalElement.style.display = 'block';
              document.body.classList.add('modal-open');
              
              // Create backdrop manually if needed
              if (!document.querySelector('.modal-backdrop')) {
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(backdrop);
              }
            }
          }
        } catch (error) {
          console.error('Error in modal setup:', error);
        }
        
        // Setup edit button
        document.getElementById('editScheduleBtn').onclick = function() {
          // Implement edit functionality
          alert('Edit functionality will be implemented in the next phase');
        };
      } catch (error) {
        console.error('Error fetching schedule details:', error);
        showErrorAlert('Failed to load schedule details. Please try again later.');
      }
    }
    
    // Delete a schedule
    async function deleteSchedule(scheduleId) {
      try {
        const response = await fetch(`/api/team-schedules/${scheduleId}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) {
          throw new Error('Failed to delete schedule');
        }
        
        // Refresh schedules
        fetchSchedules(currentTeamId);
        
        // Show success message
        showSuccessAlert('Schedule deleted successfully!');
      } catch (error) {
        console.error('Error deleting schedule:', error);
        showErrorAlert('Failed to delete schedule. Please try again later.');
      }
    }
    
    // Helper function to get badge class based on recurrence type
    function getRecurrenceBadgeClass(recurrenceType) {
      switch (recurrenceType) {
        case 'daily':
          return 'bg-primary';
        case 'weekly':
          return 'bg-success';
        case 'biweekly':
          return 'bg-info';
        case 'monthly':
          return 'bg-warning';
        default:
          return 'bg-secondary';
      }
    }
    
    // Helper function to capitalize first letter
    function capitalize(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    // Show error alert
    function showErrorAlert(message) {
      alert(message); // Simple alert for now, can be replaced with a nicer UI component
    }
    
    // Show success alert
    function showSuccessAlert(message) {
      alert(message); // Simple alert for now, can be replaced with a nicer UI component
    }

    // Calendar functionality
    
    // Initialize the FullCalendar instance
    function initializeCalendar() {
      const calendarEl = document.getElementById('calendar');
      
      // Generate colors for each team
      assignTeamColors();
      
      // Initialize the calendar
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: '',
          center: 'title',
          right: ''
        },
        height: 'auto',
        events: generateCalendarEvents(),
        eventClick: function(info) {
          // Show schedule details when clicking on an event
          const scheduleId = info.event.id;
          viewScheduleDetails(scheduleId);
        },
        eventDidMount: function(info) {
          // Add tooltip with team and member information
          const members = info.event.extendedProps.members;
          const teamName = info.event.extendedProps.teamName;
          
          let tooltipContent = `<strong>${info.event.title}</strong><br>`;
          tooltipContent += `<span class="text-muted">${teamName}</span><br>`;
          
          if (members && members.length > 0) {
            tooltipContent += `<strong>Members:</strong><br>`;
            members.slice(0, 5).forEach(member => {
              tooltipContent += `${member.firstName || member.first_name} ${member.lastName || member.last_name}<br>`;
            });
            
            if (members.length > 5) {
              tooltipContent += `and ${members.length - 5} more...`;
            }
          }
          
          // Use bootstrap tooltip or a simple title attribute
          info.el.setAttribute('title', tooltipContent.replace(/<br>/g, ' | ').replace(/<[^>]*>/g, ''));
        }
      });
      
      calendar.render();
      calendarInitialized = true;
      
      // Initially select all teams (convert IDs to strings for consistency)
      selectedTeams = new Set(teams.map(team => String(team.id)));
      updateCalendarEvents();
    }
    
    // Assign unique colors to each team
    function assignTeamColors() {
      const colors = [
        '#4285F4', // Google Blue
        '#EA4335', // Google Red
        '#FBBC05', // Google Yellow
        '#34A853', // Google Green
        '#8E24AA', // Purple
        '#00ACC1', // Cyan
        '#FB8C00', // Orange
        '#43A047', // Green
        '#E53935', // Red
        '#3949AB', // Indigo
        '#00897B', // Teal
        '#7CB342', // Light Green
        '#C0CA33', // Lime
        '#FDD835', // Yellow
        '#FFB300', // Amber
        '#F4511E', // Deep Orange
        '#6D4C41', // Brown
        '#757575', // Grey
        '#546E7A', // Blue Grey
        '#EC407A', // Pink
      ];
      
      // Assign a color to each team
      teams.forEach((team, index) => {
        // Convert to string to ensure consistent lookups
        teamColors[String(team.id)] = colors[index % colors.length];
      });
    }
    
    // Generate calendar events from schedules
    function generateCalendarEvents() {
      const events = [];
      
      schedules.forEach(schedule => {
        // Only include schedules whose team is selected
        // Convert to string to ensure consistent comparison
        const teamId = String(schedule.team_id);
        if (!selectedTeams.has(teamId)) return;
        
        // Find the team to get the color
        const color = teamColors[teamId] || '#4285F4';
        
        // Primary date range
        events.push({
          id: schedule.id,
          title: schedule.title,
          start: schedule.start_date,
          end: schedule.end_date,
          color: color,
          extendedProps: {
            teamId: schedule.team_id,
            teamName: schedule.team_name,
            members: schedule.members,
            description: schedule.description,
            recurrenceType: schedule.recurrence_type
          }
        });
        
        // Add additional date ranges if it's a recurring schedule
        if (schedule.recurrence_dates && Array.isArray(schedule.recurrence_dates)) {
          schedule.recurrence_dates.forEach(dateRange => {
            events.push({
              id: schedule.id,
              title: schedule.title,
              start: dateRange.startDate,
              end: dateRange.endDate,
              color: color,
              extendedProps: {
                teamId: schedule.team_id,
                teamName: schedule.team_name,
                members: schedule.members,
                description: schedule.description,
                recurrenceType: schedule.recurrence_type,
                isRecurrence: true
              }
            });
          });
        }
      });
      
      return events;
    }
    
    // Update calendar events based on filters
    function updateCalendarEvents() {
      if (!calendar) return;
      
      // Remove all existing events
      calendar.removeAllEvents();
      
      // Add filtered events
      calendar.addEventSource(generateCalendarEvents());
      
      // Update the legend
      updateCalendarLegend();
    }
    
    // Populate team checkboxes in the filter panel
    function populateTeamCheckboxes() {
      const teamCheckboxes = document.getElementById('teamCheckboxes');
      teamCheckboxes.innerHTML = '';
      
      teams.forEach(team => {
        const teamId = String(team.id);
        const color = teamColors[teamId] || '#4285F4';
        const isChecked = selectedTeams.has(teamId);
        
        const checkbox = document.createElement('div');
        checkbox.className = 'form-check mb-2';
        checkbox.innerHTML = `
          <input class="form-check-input team-checkbox" type="checkbox" id="team-${teamId}" 
            data-team-id="${teamId}" ${isChecked ? 'checked' : ''}>
          <label class="form-check-label d-flex align-items-center" for="team-${teamId}">
            <span class="color-dot me-2" style="background-color: ${color};"></span>
            ${team.name}
          </label>
        `;
        
        teamCheckboxes.appendChild(checkbox);
      });
      
      // Add event listeners to checkboxes
      document.querySelectorAll('.team-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const teamId = this.getAttribute('data-team-id');
          
          if (this.checked) {
            selectedTeams.add(teamId);
          } else {
            selectedTeams.delete(teamId);
          }
          
          updateCalendarEvents();
        });
      });
      
      // Update the legend
      updateCalendarLegend();
    }
    
    // Update the calendar legend with selected teams
    function updateCalendarLegend() {
      const legend = document.getElementById('calendarLegend');
      legend.innerHTML = '';
      
      // Filter teams to only show selected ones
      teams.filter(team => selectedTeams.has(String(team.id))).forEach(team => {
        const teamId = String(team.id);
        const color = teamColors[teamId] || '#4285F4';
        
        const legendItem = document.createElement('li');
        legendItem.className = 'list-group-item d-flex align-items-center';
        legendItem.innerHTML = `
          <span class="color-dot me-2" style="background-color: ${color};"></span>
          <span>${team.name}</span>
        `;
        
        legend.appendChild(legendItem);
      });
      
      // Add a message if no teams are selected
      if (selectedTeams.size === 0) {
        const noTeamsMessage = document.createElement('li');
        noTeamsMessage.className = 'list-group-item text-center text-muted';
        noTeamsMessage.textContent = 'No teams selected';
        
        legend.appendChild(noTeamsMessage);
      }
    }
    
    // Set up calendar control buttons and search
    function setupCalendarControls() {
      // Select/Clear all teams buttons
      const selectAllTeamsBtn = document.getElementById('selectAllTeamsBtn');
      const clearAllTeamsBtn = document.getElementById('clearAllTeamsBtn');
      
      selectAllTeamsBtn.addEventListener('click', function() {
        document.querySelectorAll('.team-checkbox').forEach(checkbox => {
          checkbox.checked = true;
          selectedTeams.add(checkbox.getAttribute('data-team-id'));
        });
        updateCalendarEvents();
      });
      
      clearAllTeamsBtn.addEventListener('click', function() {
        document.querySelectorAll('.team-checkbox').forEach(checkbox => {
          checkbox.checked = false;
          selectedTeams.delete(checkbox.getAttribute('data-team-id'));
        });
        updateCalendarEvents();
      });
      
      // Date navigation buttons
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const todayBtn = document.getElementById('todayBtn');
      
      prevBtn.addEventListener('click', function() {
        calendar.prev();
      });
      
      nextBtn.addEventListener('click', function() {
        calendar.next();
      });
      
      todayBtn.addEventListener('click', function() {
        calendar.today();
      });
      
      // Calendar view options
      const viewOptions = document.querySelectorAll('.view-option');
      viewOptions.forEach(option => {
        option.addEventListener('click', function() {
          // Update active state
          viewOptions.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          
          // Change calendar view
          const view = this.getAttribute('data-view');
          calendar.changeView(view);
        });
      });
      
      // Search functionality
      const searchInput = document.getElementById('calendarSearch');
      const clearSearchBtn = document.getElementById('clearSearchBtn');
      
      searchInput.addEventListener('input', debounce(function() {
        applySearch(this.value);
      }, 300));
      
      clearSearchBtn.addEventListener('click', function() {
        searchInput.value = '';
        applySearch('');
      });
    }
    
    // Debounce function to limit how often a function can be called
    function debounce(func, wait) {
      let timeout;
      return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    }
    
    // Apply search filter to calendar events
    function applySearch(query) {
      if (!query || query.trim() === '') {
        // If query is empty, show all events for selected teams
        calendar.removeAllEvents();
        calendar.addEventSource(generateCalendarEvents());
        return;
      }
      
      query = query.toLowerCase().trim();
      const filteredEvents = [];
      
      schedules.forEach(schedule => {
        // Only include schedules whose team is selected
        // Convert to string to ensure consistent comparison
        const teamId = String(schedule.team_id);
        if (!selectedTeams.has(teamId)) return;
        
        // Check if query matches schedule title, team name, or any member name
        const titleMatch = schedule.title.toLowerCase().includes(query);
        const teamMatch = schedule.team_name.toLowerCase().includes(query);
        
        let memberMatch = false;
        if (schedule.members && Array.isArray(schedule.members)) {
          memberMatch = schedule.members.some(member => {
            const firstName = (member.firstName || member.first_name || '').toLowerCase();
            const lastName = (member.lastName || member.last_name || '').toLowerCase();
            return firstName.includes(query) || lastName.includes(query) || 
                   `${firstName} ${lastName}`.includes(query);
          });
        }
        
        if (titleMatch || teamMatch || memberMatch) {
          // Find the team to get the color
          const color = teamColors[String(schedule.team_id)] || '#4285F4';
          
          // Primary date range
          filteredEvents.push({
            id: schedule.id,
            title: schedule.title,
            start: schedule.start_date,
            end: schedule.end_date,
            color: color,
            extendedProps: {
              teamId: schedule.team_id,
              teamName: schedule.team_name,
              members: schedule.members,
              description: schedule.description,
              recurrenceType: schedule.recurrence_type
            }
          });
          
          // Add additional date ranges if it's a recurring schedule
          if (schedule.recurrence_dates && Array.isArray(schedule.recurrence_dates)) {
            schedule.recurrence_dates.forEach(dateRange => {
              filteredEvents.push({
                id: schedule.id,
                title: schedule.title,
                start: dateRange.startDate,
                end: dateRange.endDate,
                color: color,
                extendedProps: {
                  teamId: schedule.team_id,
                  teamName: schedule.team_name,
                  members: schedule.members,
                  description: schedule.description,
                  recurrenceType: schedule.recurrence_type,
                  isRecurrence: true
                }
              });
            });
          }
        }
      });
      
      // Update calendar with filtered events
      calendar.removeAllEvents();
      calendar.addEventSource(filteredEvents);
    }
    
    // Add CSS for the calendar components
    document.addEventListener('DOMContentLoaded', function() {
      const style = document.createElement('style');
      style.textContent = `
        .color-dot {
          display: inline-block;
          width: 12px;
          height: 12px;
          border-radius: 50%;
        }
        
        #calendar {
          min-height: 600px;
        }
        
        .fc-event {
          cursor: pointer;
          border-radius: 4px;
        }
        
        .fc-event-title {
          font-weight: 500;
          white-space: normal;
        }
        
        .view-option.active {
          background-color: #0d6efd;
          color: white;
        }
        
        .team-filter-list {
          max-height: 200px;
          overflow-y: auto;
        }
      `;
      document.head.appendChild(style);
    });
  </script>
</body>
</html>